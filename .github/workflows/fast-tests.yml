name: Fast Tests (PR)

on:
  workflow_dispatch:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODOs and FIXMEs
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for TODOs and FIXMEs in source code..."
          TODOS=$(grep -r "TODO" Sources/ 2>/dev/null || true)
          FIXMES=$(grep -r "FIXME" Sources/ 2>/dev/null || true)

          if [ -n "$TODOS" ] || [ -n "$FIXMES" ]; then
            echo "âš ï¸  Found TODO/FIXME comments in source code:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$TODOS" ]; then
              echo "**TODOs:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$TODOS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$FIXMES" ]; then
              echo "**FIXMEs:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FIXMES" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "â„¹ï¸  This is a warning only."  >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No TODO/FIXME comments found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for large files
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for large files (>1MB)..."
          LARGE_FILES=$(find . -type f -size +1M -not -path "./.build/*" -not -path "./.git/*" 2>/dev/null || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸  Found large files (>1MB):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$LARGE_FILES" | while read file; do
              if [ -f "$file" ]; then
                SIZE=$(ls -lh "$file" | awk '{print $5}')
                echo "$file ($SIZE)"
              fi
            done >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No large files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for print statements
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for print statements in production code..."
          PRINTS=$(grep -r "print(" Sources/ --include="*.swift" --exclude-dir="Examples" 2>/dev/null || true)

          if [ -n "$PRINTS" ]; then
            COUNT=$(echo "$PRINTS" | wc -l | tr -d ' ')
            echo "âš ï¸  Found $COUNT print statement(s):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$PRINTS" | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No print statements found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Swift build check
        run: |
          echo "ðŸ”¨ Verifying Swift package builds..."
          swift build --configuration debug
          echo "âœ… Swift package builds successfully" >> $GITHUB_STEP_SUMMARY

  fast-test-macos:
    name: Fast Tests (macOS)
    runs-on: macos-26
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Build for macOS
        run: |
          echo "ðŸ”¨ Building for macOS"
          xcodebuild build \
            -scheme SwiftHablare \
            -destination 'platform=macOS' \
            -skipPackagePluginValidation \
            | xcpretty || true

      - name: Clean test database
        run: |
          # Remove any existing test databases to prevent schema conflicts
          rm -rf ~/Library/Application\ Support/default.store*
          rm -rf ~/Library/Application\ Support/*.store

      - name: Run unit tests on macOS
        run: |
          echo "ðŸƒ Running unit tests on macOS"
          echo "Platform: macOS"
          echo "Destination: platform=macOS"
          echo ""

          # Pass GitHub Actions' built-in CI variable to test process
          # Skip integration and performance tests for fast PR feedback
          TEST_RUNNER_CI="${CI}" xcodebuild test \
            -scheme SwiftHablare \
            -destination 'platform=macOS' \
            -skipPackagePluginValidation \
            -skip-testing:SwiftHablareTests/AppleVoiceProviderIntegrationTests \
            -skip-testing:SwiftHablareTests/ElevenLabsVoiceProviderIntegrationTests \
            -skip-testing:SwiftHablareTests/PerformanceIntegrationTests \
            | tee test-output-macOS.log \
            | xcpretty --test --color

          TEST_EXIT_CODE=${PIPESTATUS[0]}

          if grep -q "TEST FAILED" test-output-macOS.log || grep -q "\*\* TEST FAILED \*\*" test-output-macOS.log; then
            echo "âŒ Tests failed"
            exit 1
          elif grep -q "TEST SUCCEEDED" test-output-macOS.log || grep -q "\*\* TEST SUCCEEDED \*\*" test-output-macOS.log; then
            echo "âœ… Tests succeeded"
            exit 0
          else
            echo "âš ï¸  Could not determine test status, using xcodebuild exit code: $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

      - name: Extract test summary
        if: always()
        shell: bash {0}
        run: |
          echo "## Unit Test Results - macOS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** macOS" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** platform=macOS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  **Note:** Integration tests run weekly on schedule." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-macOS.log ]; then
            LAST_EXECUTION_LINE=$(grep "Executed.*test" test-output-macOS.log | tail -n 1 || true)

            if [ -n "$LAST_EXECUTION_LINE" ]; then
              TOTAL_TESTS=$(echo "$LAST_EXECUTION_LINE" | grep -o "Executed [0-9]*" | grep -o "[0-9]*" || echo "0")
              FAILURES=$(echo "$LAST_EXECUTION_LINE" | grep -o "with [0-9]* failure" | grep -o "[0-9]*" || echo "0")

              if [ -z "$FAILURES" ] || [ "$FAILURES" = "" ]; then
                FAILURES=0
              fi

              if [ -z "$TOTAL_TESTS" ] || [ "$TOTAL_TESTS" = "" ] || [ "$TOTAL_TESTS" = "0" ]; then
                echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
              else
                PASSED=$((TOTAL_TESTS - FAILURES))

                if [ "$FAILURES" -eq 0 ]; then
                  echo "âœ… **All unit tests passed:** $TOTAL_TESTS/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ **Failed:** $FAILURES/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… **Passed:** $PASSED/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fast-test-results-macOS
          path: |
            test-output-macOS.log
          retention-days: 7

  # Step 3: Integration Tests (CLI binary smoke test)
  integration-tests:
    name: Integration Tests
    runs-on: macos-26
    needs: [code-quality]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build hablare CLI (Release)
        run: |
          make release
          ls -la ./bin/

      - name: Verify CLI binary
        run: |
          echo "Checking hablare --version"
          ./bin/hablare --version
          echo "Checking hablare --help"
          ./bin/hablare --help
          echo "Checking hablare generate --help"
          ./bin/hablare generate --help
          echo "Checking hablare voices --help"
          ./bin/hablare voices --help
          echo "Checking hablare download --help"
          ./bin/hablare download --help
          echo "Checking hablare info --help"
          ./bin/hablare info --help
