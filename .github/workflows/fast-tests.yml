name: Fast Tests (PR)

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  fast-test:
    name: Fast Tests (${{ matrix.platform }})
    runs-on: macos-26
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: iOS
            destination: 'platform=iOS Simulator,name=iPhone 17'
            skip_integration: true
          - platform: Catalyst
            destination: 'platform=macOS,variant=Mac Catalyst'
            skip_integration: true
          - platform: macOS
            destination: 'platform=macOS'
            skip_integration: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Show available simulators
        if: matrix.platform == 'iOS'
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available | grep "iPhone" | head -5

      - name: Build for ${{ matrix.platform }}
        run: |
          echo "ðŸ”¨ Building for ${{ matrix.platform }}"
          xcodebuild build \
            -scheme SwiftHablare \
            -destination '${{ matrix.destination }}' \
            -skipPackagePluginValidation \
            | xcpretty || true

      - name: Clean test database
        run: |
          # Remove any existing test databases to prevent schema conflicts
          rm -rf ~/Library/Application\ Support/default.store*
          rm -rf ~/Library/Application\ Support/*.store

      - name: Run fast tests on ${{ matrix.platform }} (unit tests only)
        run: |
          echo "ðŸƒ Running fast tests on ${{ matrix.platform }} (unit tests only)"
          echo "Platform: ${{ matrix.platform }}"
          echo "Destination: ${{ matrix.destination }}"
          echo "Integration tests will run on the weekly schedule"
          echo ""

          # Run tests using xcodebuild (required for iOS and macOS platform-specific tests)
          # Skip integration tests (tests with "Integration" in the name)
          xcodebuild test \
            -scheme SwiftHablare \
            -destination '${{ matrix.destination }}' \
            -skipPackagePluginValidation \
            -skip-testing:SwiftHablareTests/AppleVoiceProviderIntegrationTests \
            -skip-testing:SwiftHablareTests/ElevenLabsVoiceProviderIntegrationTests \
            | tee test-output-${{ matrix.platform }}.log \
            | xcpretty --test --color

          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          # Check if tests actually failed (not just warnings)
          # xcodebuild returns non-zero for warnings, but we only want to fail on test failures
          if grep -q "TEST FAILED" test-output-${{ matrix.platform }}.log || grep -q "** TEST FAILED **" test-output-${{ matrix.platform }}.log; then
            echo "âŒ Tests failed"
            exit 1
          elif grep -q "TEST SUCCEEDED" test-output-${{ matrix.platform }}.log || grep -q "** TEST SUCCEEDED **" test-output-${{ matrix.platform }}.log; then
            echo "âœ… Tests succeeded"
            exit 0
          else
            # If we can't determine test status, use xcodebuild exit code
            echo "âš ï¸  Could not determine test status, using xcodebuild exit code: $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

      - name: Extract test summary
        if: always()
        run: |
          echo "## Fast Test Results - ${{ matrix.platform }} (Unit Tests Only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** ${{ matrix.destination }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  **Note:** Integration tests are skipped in PR checks and run weekly on schedule." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-${{ matrix.platform }}.log ]; then
            # Extract test results from xcodebuild test output
            # Get the last "Executed X tests" line which has the total
            LAST_EXECUTION_LINE=$(grep "Executed.*test" test-output-${{ matrix.platform }}.log | tail -n 1)

            if [ -n "$LAST_EXECUTION_LINE" ]; then
              # Extract numbers from the line
              TOTAL_TESTS=$(echo "$LAST_EXECUTION_LINE" | grep -o "Executed [0-9]*" | grep -o "[0-9]*")
              FAILURES=$(echo "$LAST_EXECUTION_LINE" | grep -o "with [0-9]* failure" | grep -o "[0-9]*")

              if [ -z "$FAILURES" ]; then
                FAILURES=0
              fi

              PASSED=$((TOTAL_TESTS - FAILURES))

              # Display results
              if [ "$FAILURES" -eq 0 ]; then
                echo "âœ… **All unit tests passed:** $TOTAL_TESTS/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **Failed:** $FAILURES/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "âœ… **Passed:** $PASSED/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fast-test-results-${{ matrix.platform }}
          path: |
            test-output-${{ matrix.platform }}.log
          retention-days: 7
