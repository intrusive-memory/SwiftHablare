name: Tests

on:
  workflow_dispatch:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODOs and FIXMEs
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for TODOs and FIXMEs in source code..."
          TODOS=$(grep -r "TODO" Sources/ 2>/dev/null || true)
          FIXMES=$(grep -r "FIXME" Sources/ 2>/dev/null || true)

          if [ -n "$TODOS" ] || [ -n "$FIXMES" ]; then
            echo "âš ï¸  Found TODO/FIXME comments in source code:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$TODOS" ]; then
              echo "**TODOs:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$TODOS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$FIXMES" ]; then
              echo "**FIXMEs:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FIXMES" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "â„¹ï¸  This is a warning only."  >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No TODO/FIXME comments found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for large files
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for large files (>1MB)..."
          LARGE_FILES=$(find . -type f -size +1M -not -path "./.build/*" -not -path "./.git/*" 2>/dev/null || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸  Found large files (>1MB):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$LARGE_FILES" | while read file; do
              if [ -f "$file" ]; then
                SIZE=$(ls -lh "$file" | awk '{print $5}')
                echo "$file ($SIZE)"
              fi
            done >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No large files found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for print statements
        shell: bash {0}
        run: |
          echo "ðŸ” Checking for print statements in production code..."
          PRINTS=$(grep -r "print(" Sources/ --include="*.swift" --exclude-dir="Examples" 2>/dev/null || true)

          if [ -n "$PRINTS" ]; then
            COUNT=$(echo "$PRINTS" | wc -l | tr -d ' ')
            echo "âš ï¸  Found $COUNT print statement(s):" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$PRINTS" | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No print statements found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Xcodebuild check
        run: |
          echo "ðŸ”¨ Verifying package builds..."
          xcodebuild build \
            -scheme SwiftHablare \
            -destination 'platform=macOS' \
            -configuration Debug
          echo "âœ… Package builds successfully" >> $GITHUB_STEP_SUMMARY

  macos-tests:
    name: macOS Tests
    runs-on: macos-26
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Clean test database
        run: |
          rm -rf ~/Library/Application\ Support/default.store*
          rm -rf ~/Library/Application\ Support/*.store

      - name: Run unit tests on macOS
        run: |
          echo "ðŸƒ Running unit tests on macOS via xcodebuild"
          xcodebuild test \
            -scheme SwiftHablare \
            -destination 'platform=macOS' \
            -only-testing:SwiftHablareTests \
            2>&1 | tee test-output-macOS.log
          echo "âœ… Tests completed"

      - name: Extract test summary
        if: always()
        shell: bash {0}
        run: |
          echo "## Unit Test Results - macOS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-output-macOS.log ]; then
            echo "Tests completed. See job logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: |
            test-output-macOS.log
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: macos-26
    needs: [code-quality]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Build hablare CLI (Release)
        run: |
          make release
          ls -la ./bin/

      - name: Verify CLI binary
        run: |
          echo "Checking hablare --version"
          ./bin/hablare --version
          echo "Checking hablare --help"
          ./bin/hablare --help
          echo "Checking hablare generate --help"
          ./bin/hablare generate --help
          echo "Checking hablare voices --help"
          ./bin/hablare voices --help
          echo "Checking hablare download --help"
          ./bin/hablare download --help
          echo "Checking hablare info --help"
          ./bin/hablare info --help
