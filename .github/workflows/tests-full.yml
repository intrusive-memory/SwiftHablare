name: Full Test Suite (Manual)

on:
  # Only run manually - replaced by fast-tests.yml (PR) and integration-tests.yml (weekly)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Full Test Suite (${{ matrix.platform }})
    runs-on: macos-26
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: iOS
            destination: 'platform=iOS Simulator,name=iPhone 17'
          - platform: macOS
            destination: 'platform=macOS'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Show available simulators
        if: matrix.platform == 'iOS'
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available | grep "iPhone" | head -5

      - name: Build for ${{ matrix.platform }}
        run: |
          echo "üî® Building for ${{ matrix.platform }}"
          xcodebuild build \
            -scheme SwiftHablare \
            -destination '${{ matrix.destination }}' \
            -skipPackagePluginValidation \
            | xcpretty || true

      - name: Clean test database
        run: |
          # Remove any existing test databases to prevent schema conflicts
          rm -rf ~/Library/Application\ Support/default.store*
          rm -rf ~/Library/Application\ Support/*.store

      - name: Run all tests on ${{ matrix.platform }} (unit + integration)
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        run: |
          echo "üß™ Running FULL test suite on ${{ matrix.platform }} (unit + integration)"
          echo "Platform: ${{ matrix.platform }}"
          echo "Destination: ${{ matrix.destination }}"
          echo "This is a manual workflow. Normally:"
          echo "  - Fast tests run on PRs (fast-tests.yml)"
          echo "  - Integration tests run weekly (integration-tests.yml)"
          echo ""

          # Run all tests including integration tests (if ELEVENLABS_API_KEY is set)
          if [ -n "$ELEVENLABS_API_KEY" ]; then
            echo "‚úÖ ElevenLabs API key found - integration tests will run"
          else
            echo "‚ö†Ô∏è  ElevenLabs API key not found - integration tests will be skipped"
          fi

          # Run all tests using xcodebuild (required for iOS/macOS)
          xcodebuild test \
            -scheme SwiftHablare \
            -destination '${{ matrix.destination }}' \
            -skipPackagePluginValidation \
            | tee test-output-${{ matrix.platform }}.log \
            | xcpretty --test --color

          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          # Exit with the test exit code
          exit $TEST_EXIT_CODE

      - name: Run performance tests on ${{ matrix.platform }}
        if: always()
        continue-on-error: true
        run: |
          echo "üìä Running performance tests on ${{ matrix.platform }}"
          # Run performance tests separately if they exist
          xcodebuild test \
            -scheme SwiftHablare \
            -destination '${{ matrix.destination }}' \
            -skipPackagePluginValidation \
            -only-testing:SwiftHablareTests/PerformanceTests \
            2>&1 | tee performance-output-${{ matrix.platform }}.log || true

          # Extract performance metrics from output
          grep "PERFORMANCE_METRIC:" performance-output-${{ matrix.platform }}.log | sed 's/PERFORMANCE_METRIC: //' > performance-metrics-${{ matrix.platform }}.json || true

      - name: Generate coverage report
        if: false  # Disabled: coverage generation has object mismatch issues with isolated test instances
        run: |
          # Find the xctest bundle and profdata file without rebuilding
          XCTEST_PATH=$(find .build -name "*.xctest" | head -n 1)
          PROFDATA_PATH=$(find .build -name "*.profdata" | head -n 1)

          echo "XCTEST_PATH: $XCTEST_PATH"
          echo "PROFDATA_PATH: $PROFDATA_PATH"

          if [ -n "$PROFDATA_PATH" ] && [ -f "$PROFDATA_PATH" ] && [ -n "$XCTEST_PATH" ] && [ -d "$XCTEST_PATH" ]; then
            echo "Found profdata at: $PROFDATA_PATH"
            echo "Found xctest at: $XCTEST_PATH"

            # Generate coverage report
            xcrun llvm-cov report \
              "$XCTEST_PATH/Contents/MacOS/"* \
              -instr-profile="$PROFDATA_PATH" \
              -ignore-filename-regex=".build|Tests" \
              > coverage-report.txt

            # Generate detailed coverage export
            xcrun llvm-cov export \
              "$XCTEST_PATH/Contents/MacOS/"* \
              -instr-profile="$PROFDATA_PATH" \
              -ignore-filename-regex=".build|Tests" \
              -format=lcov \
              > coverage.lcov

            echo "Coverage report generated"
            cat coverage-report.txt
          else
            echo "Error: Could not find required files for coverage generation"
            [ -z "$PROFDATA_PATH" ] && echo "  - profdata file not found"
            [ -z "$XCTEST_PATH" ] && echo "  - xctest bundle not found"
            exit 1
          fi

      - name: Extract test summary
        if: always()
        run: |
          echo "## Test Results - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** ${{ matrix.destination }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output-${{ matrix.platform }}.log ]; then
            # Extract test results from xcodebuild test output
            # Get the last "Executed X tests" line which has the total
            LAST_EXECUTION_LINE=$(grep "Executed.*test" test-output-${{ matrix.platform }}.log | tail -n 1)

            if [ -n "$LAST_EXECUTION_LINE" ]; then
              # Extract numbers from the line
              TOTAL_TESTS=$(echo "$LAST_EXECUTION_LINE" | grep -o "Executed [0-9]*" | grep -o "[0-9]*")
              FAILURES=$(echo "$LAST_EXECUTION_LINE" | grep -o "with [0-9]* failure" | grep -o "[0-9]*")

              if [ -z "$FAILURES" ]; then
                FAILURES=0
              fi

              PASSED=$((TOTAL_TESTS - FAILURES))

              # Display results
              if [ "$FAILURES" -eq 0 ]; then
                echo "‚úÖ **All tests passed:** $TOTAL_TESTS/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå **Failed:** $FAILURES/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
                echo "‚úÖ **Passed:** $PASSED/$TOTAL_TESTS tests" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Tests completed. Check job logs for detailed results." >> $GITHUB_STEP_SUMMARY
            fi

            # Check for integration test execution
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Integration Tests" >> $GITHUB_STEP_SUMMARY

            # Check if Apple integration tests ran
            if grep -q "AppleVoiceProviderIntegrationTests" test-output-${{ matrix.platform }}.log; then
              APPLE_TESTS=$(grep -c "‚úÖ.*apple-tts-.*\.aiff" test-output-${{ matrix.platform }}.log || echo "0")
              echo "- ‚úÖ Apple Voice Provider: $APPLE_TESTS audio artifacts generated" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚ö†Ô∏è  Apple Voice Provider: No integration tests found" >> $GITHUB_STEP_SUMMARY
            fi

            # Check if ElevenLabs integration tests ran
            if grep -q "ElevenLabsVoiceProviderIntegrationTests" test-output-${{ matrix.platform }}.log; then
              if grep -q "ELEVENLABS_API_KEY.*not set.*skipping" test-output-${{ matrix.platform }}.log; then
                echo "- ‚è≠Ô∏è  ElevenLabs: Tests skipped (no API key)" >> $GITHUB_STEP_SUMMARY
              else
                ELEVENLABS_TESTS=$(grep -c "‚úÖ.*elevenlabs-tts-.*\.mp3" test-output-${{ matrix.platform }}.log || echo "0")
                echo "- ‚úÖ ElevenLabs: $ELEVENLABS_TESTS audio artifacts generated" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- ‚ö†Ô∏è  ElevenLabs: No integration tests found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test output found" >> $GITHUB_STEP_SUMMARY
          fi

          # Add performance metrics section
          if [ -f performance-metrics-${{ matrix.platform }}.json ] && [ -s performance-metrics-${{ matrix.platform }}.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value | Unit |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|------|" >> $GITHUB_STEP_SUMMARY

            # Parse each line of JSON metrics
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                NAME=$(echo "$line" | grep -o '"name":"[^"]*"' | sed 's/"name":"//' | sed 's/"//')
                VALUE=$(echo "$line" | grep -o '"value":[0-9.]*' | sed 's/"value"://')
                UNIT=$(echo "$line" | grep -o '"unit":"[^"]*"' | sed 's/"unit":"//' | sed 's/"//')

                if [ -n "$NAME" ] && [ -n "$VALUE" ] && [ -n "$UNIT" ]; then
                  # Format value to 2 decimal places
                  VALUE_FORMATTED=$(printf "%.2f" "$VALUE")
                  echo "| $NAME | $VALUE_FORMATTED | $UNIT |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done < performance-metrics-${{ matrix.platform }}.json
          fi

          if [ -f coverage-report.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract overall coverage percentage
            COVERAGE=$(grep -oE '[0-9]+\.[0-9]+%' coverage-report.txt | head -n 1)
            if [ -n "$COVERAGE" ]; then
              echo "**Overall Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "<details><summary>Detailed Coverage Report</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat coverage-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate coverage badge
        if: false  # Disabled: coverage generation is disabled
        run: |
          if [ -f coverage-report.txt ]; then
            .github/scripts/generate-coverage-badge.sh coverage-report.txt .github/coverage-badge.json
          fi

      - name: Upload test results and coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-and-coverage-${{ matrix.platform }}
          path: |
            test-output-${{ matrix.platform }}.log
            performance-output-${{ matrix.platform }}.log
            performance-metrics-${{ matrix.platform }}.json
            coverage-report.txt
            coverage.lcov
            .github/coverage-badge.json
            .build/*/TestArtifacts/**/*.aiff
            .build/*/TestArtifacts/**/*.mp3
          retention-days: 30

      - name: Check coverage threshold
        if: false  # Disabled: coverage generation is disabled
        run: |
          if [ -f coverage-report.txt ]; then
            # Extract overall coverage percentage
            COVERAGE=$(grep -oE '[0-9]+\.[0-9]+%' coverage-report.txt | head -n 1 | sed 's/%//')
            echo "Overall coverage: $COVERAGE%"

            # Check if coverage meets 80% threshold
            THRESHOLD=80
            if (( $(echo "$COVERAGE >= $THRESHOLD" | bc -l) )); then
              echo "‚úÖ Coverage threshold met: $COVERAGE% >= $THRESHOLD%"
            else
              echo "‚ö†Ô∏è  Coverage below threshold: $COVERAGE% < $THRESHOLD%"
              echo "::warning::Code coverage ($COVERAGE%) is below the threshold ($THRESHOLD%)"
            fi
          fi
