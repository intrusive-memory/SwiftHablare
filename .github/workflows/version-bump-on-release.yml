name: Bump Version on Release

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: macos-latest

    steps:
      - name: Checkout development branch
        uses: actions/checkout@v4
        with:
          ref: development
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract current version from CLAUDE.md
        id: current-version
        run: |
          CURRENT_VERSION=$(grep -oE 'Current Version\*\*: [0-9]+\.[0-9]+\.[0-9]+' CLAUDE.md | sed 's/Current Version\*\*: //')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version (minor bump)
        id: new-version
        run: |
          CURRENT="${{ steps.current-version.outputs.current }}"

          # Split version into components
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)

          # Default to minor bump (increment MINOR, reset PATCH to 0)
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"

          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update version in CLAUDE.md
        run: |
          OLD_VERSION="${{ steps.current-version.outputs.current }}"
          NEW_VERSION="${{ steps.new-version.outputs.new }}"

          # Update version in Version Information section
          sed -i '' "s/Current Version\*\*: ${OLD_VERSION}/Current Version**: ${NEW_VERSION}/g" CLAUDE.md

          echo "Updated CLAUDE.md version references"

      - name: Update version in CHANGELOG.md
        run: |
          OLD_VERSION="${{ steps.current-version.outputs.current }}"
          NEW_VERSION="${{ steps.new-version.outputs.new }}"

          # Update version in Current Status section
          sed -i '' "s/Version\*\*: ${OLD_VERSION}/Version**: ${NEW_VERSION}/g" CHANGELOG.md

          echo "Updated CHANGELOG.md version references"

      - name: Verify changes
        run: |
          echo "=== Git diff ==="
          git diff
          echo "=== Files changed ==="
          git status --short

      - name: Commit version bump
        run: |
          git add CLAUDE.md CHANGELOG.md
          git commit -m "chore: Bump version to ${{ steps.new-version.outputs.new }} after release ${{ github.event.release.tag_name }}

          Automated version bump following release ${{ github.event.release.tag_name }}.
          Previous version: ${{ steps.current-version.outputs.current }}
          New version: ${{ steps.new-version.outputs.new }}

          ðŸ¤– Generated by GitHub Actions"

      - name: Push to development
        run: |
          git push origin development

      - name: Create pull request to main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head development \
            --title "${{ steps.new-version.outputs.new }} => ${{ steps.current-version.outputs.current }}" \
            --body "## Automated Version Bump

          This PR contains an automated version bump following the publication of release **${{ github.event.release.tag_name }}**.

          ### Changes

          - **Previous version**: ${{ steps.current-version.outputs.current }}
          - **New version**: ${{ steps.new-version.outputs.new }}
          - **Bump type**: Minor version bump (default)
          - **Release**: ${{ github.event.release.tag_name }}
          - **Release URL**: ${{ github.event.release.html_url }}

          ### Files Updated

          - \`CLAUDE.md\` - Current Version field
          - \`CHANGELOG.md\` - Version in Current Status section

          ### What's Next

          After this PR is merged, future development work will be based on version ${{ steps.new-version.outputs.new }}.

          ### Version Bumping Strategy

          - **Minor bumps** (default): Regular feature releases
          - **Major bumps**: Breaking changes or massive refactors (manual)
          - **Patch bumps**: Bug fixes (manual)

          ðŸ¤– Automated by GitHub Actions" || echo "PR may already exist or no changes to commit"
